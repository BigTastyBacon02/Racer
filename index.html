<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Trans Am '75: E‚ÄëKarren-√úberholer</title>

<link rel="manifest" href="manifest.webmanifest?v=5">
<meta name="theme-color" content="#0b0b10">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Trans Am '75">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">

<style>
  :root{--ui:#ffe000;--fg:#e8e8e8;--bg:#000;--pink:#ff2e7a;--cyan:#38e6ff;}
  html,body{margin:0;height:100%;background:#000;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;touch-action:none}
  #wrap{position:fixed;inset:0;overflow:hidden;background:#000}
  canvas{width:100%;height:100%;display:block;image-rendering:pixelated;background:#000}
  /* HUD */
  .hud{position:absolute;left:0;right:0;top:0;padding:8px 10px;pointer-events:none;display:flex;justify-content:space-between;gap:8px;font-weight:800;text-shadow:0 1px 0 #000,0 0 6px #000}
  .hud .left,.hud .right{display:flex;gap:10px;align-items:center}
  .badge{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:10px}
  .boostbar{width:150px;height:12px;border:1px solid rgba(255,255,255,.28);border-radius:999px;overflow:hidden;background:rgba(0,0,0,.35)}
  .boostbar>div{height:100%;background:linear-gradient(90deg,#fff,var(--pink));width:0%}
  /* Touch */
  .touch{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;pointer-events:auto}
  .btn{user-select:none;-webkit-user-select:none;-webkit-tap-highlight-color:transparent;touch-action:none;color:#fff;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center}
  .btn span{opacity:.35;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:10px}
  .btn:active span{opacity:.9}
  .btn-left{grid-area:2/1/3/2}.btn-right{grid-area:2/2/3/3}.btn-boost{position:absolute;right:10px;bottom:10px}
  /* Neon Menu */
  .menu, .gameover{position:absolute;inset:0;z-index:5;display:flex;align-items:center;justify-content:center;text-align:center;padding:24px;pointer-events:auto}
  .menu:before, .gameover:before{content:"";position:absolute;inset:-40%;background:radial-gradient(600px 300px at 30% 30%, rgba(255,46,122,.18), transparent 60%), radial-gradient(600px 300px at 70% 60%, rgba(56,230,255,.15), transparent 60%);filter:blur(30px);}
  .panel{position:relative;max-width:760px;width:clamp(300px,92vw,760px);border:2px solid rgba(255,255,255,.08);background:rgba(10,10,12,.9);backdrop-filter:blur(6px);border-radius:18px;padding:22px 20px 18px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .logo{font-weight:900;letter-spacing:.6px;margin:0 0 10px 0;font-size:34px;background:linear-gradient(90deg,var(--ui),#fff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 20px rgba(255,224,0,.25)}
  .subtitle{opacity:.8;margin-top:-4px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:16px}
  button{cursor:pointer;background:var(--ui);color:#000;font-weight:900;border:none;border-radius:12px;padding:12px 18px}
  button.secondary{background:#17171b;color:#eaeaea;border:1px solid #2a2a2f}
  .credits{margin-top:10px;font-size:12px;opacity:.75}
  .scroll{max-height:32vh;overflow:auto;text-align:left;border:1px solid #23232a;background:#0e0e12;border-radius:12px;padding:10px;font-size:14px}
  .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:999px;font-size:12px;pointer-events:none}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game" aria-label="PS1 Racer Canvas"></canvas>

  <div class="hud" id="hud" style="display:none">
    <div class="left">
      <div class="badge">Lvl <span id="uiLevel">1</span></div>
      <div class="badge">Speed <span id="uiSpeed">0</span></div>
      <div class="badge">√úberholt <span id="uiPassed">0</span></div>
    </div>
    <div class="right">
      <div class="badge">Boost</div>
      <div class="boostbar"><div id="boostFill"></div></div>
      <div class="badge" id="uiFPS" style="min-width:52px;text-align:right;">60</div>
    </div>
  </div>

  <div class="touch" id="touch" style="display:none">
    <div class="btn btn-left" data-act="left"><span>‚óÄ</span></div>
    <div class="btn btn-right" data-act="right"><span>‚ñ∂</span></div>
    <div class="btn btn-boost" data-act="boost"><span>BOOST</span></div>
  </div>

  <!-- Main menu -->
  <div class="menu" id="menu">
    <div class="panel">
      <h1 class="logo">Trans Am ‚Äô75</h1>
      <div class="subtitle">E‚ÄëKarren‚Äë√úberholer ‚Äî PS1‚ÄëLow‚ÄëPoly, Metal & Vibration</div>
      <div class="row">
        <button id="btnStart">Start üöó‚ö°</button>
        <button class="secondary" id="btnHow">Steuerung</button>
        <button class="secondary" id="btnQuips">Spr√ºche</button>
      </div>
      <div id="how" style="display:none; margin-top:12px;">
        <div class="scroll">
          <b>Steuerung</b>
          <ul>
            <li>Links/Rechts: ‚Üê ‚Üí oder A/D (Touch: Buttons)</li>
            <li>Boost: Leertaste / B (Touch: BOOST)</li>
            <li>Pause: P</li>
            <li>Goal: √úberhole das Ziel pro Level, ohne zu crashen.</li>
          </ul>
        </div>
      </div>
      <div id="quipbox" style="display:none; margin-top:12px;">
        <div class="scroll" id="quiplist"></div>
      </div>
      <div class="credits">Pro‚ÄëTipp: Handy quer halten. Lautst√§rke an. Wenn‚Äôs vibriert: Absicht üòâ</div>
    </div>
  </div>

  <!-- Game Over -->
  <div class="gameover" id="gameover" style="display:none">
    <div class="panel">
      <h2 class="logo">Game Over</h2>
      <div id="stats"></div>
      <div class="row" style="margin-top:14px;">
        <button id="btnRetry">Nochmal!</button>
        <button class="secondary" id="btnMenu">Men√º</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" style="display:none">Pause ‚Äì P zum Fortsetzen</div>
</div>

<script>
(() => {
  // ====== Config (v5 Hard Mode) ======
  const LOW_W=192, LOW_H=108, SCALE_FOV=72, ROAD_W=1.9, LANE_COUNT=3;
  const MAX_SPEED=240, BOOST_MULT=1.6, BOOST_CHARGE_RATE=0.10, BOOST_DRAIN=0.85;
  const CAR_SIZE={w:.25,h:.10,d:.45};
  const LEVELS=[
    { name:"Kaltstart", traffic:1.4, minGap:5.3, bg:"#162126", fog:"#0a0a0a", target:35 },
    { name:"Lades√§ulen-Safari", traffic:1.8, minGap:4.8, bg:"#0e2642", fog:"#040a12", target:60 },
    { name:"E‚ÄëKoalition", traffic:2.2, minGap:4.2, bg:"#1a1a3a", fog:"#0a0a15", target:90 },
    { name:"√ñko‚ÄëApokalypse", traffic:2.6, minGap:3.8, bg:"#2a0e0e", fog:"#120606", target:130 },
  ];

  const QUIPS_PASS=["CO2? Mehr so C‚ÄëO‚ÄëTsch√ºss!","Gr√º√üe an die Reichweitenangst!","Schneller als Update 37.4.2!","Ich fahr' mit Emotionen, nicht mit Emissionen.","Overtake: sponsored by V8‚ÄëKaffee.","L√§dt ihr noch oder fahrt ihr schon?","Tank leer. Humor voll.","Boost ist Liebe.","E‚ÄëKarren sind nur Deko.","Die Umwelt so: üëÄ","Blinker? Kenn ich nur von anderen."];
  const QUIPS_CRASH=["Aua. Sto√üstange sucht Anschluss.","Das war Reibungsenergie.","Bitte wenden. Auch innerlich.","Fahrwerk sagt: Nein.","Du hattest Vorfahrt. Theoretisch."];
  const QUIPS_START=["Sicherheitsgurt? Ist doch nur Gewicht.","Z√ºndung an. Playlist: S√§gewerk.","V8 auf Betriebstemperatur.","Karten‚ÄëUpdate: Keine Lades√§ulen gefunden."];

  const el={cvs:document.getElementById('game'),hud:document.getElementById('hud'),uiLevel:document.getElementById('uiLevel'),uiSpeed:document.getElementById('uiSpeed'),uiPassed:document.getElementById('uiPassed'),boostFill:document.getElementById('boostFill'),fps:document.getElementById('uiFPS'),menu:document.getElementById('menu'),gameover:document.getElementById('gameover'),stats:document.getElementById('stats'),btnStart:document.getElementById('btnStart'),btnHow:document.getElementById('btnHow'),btnQuips:document.getElementById('btnQuips'),how:document.getElementById('how'),quipbox:document.getElementById('quipbox'),quiplist:document.getElementById('quiplist'),btnRetry:document.getElementById('btnRetry'),btnMenu:document.getElementById('btnMenu'),toast:document.getElementById('toast'),touch:document.getElementById('touch')};
  const ctx=el.cvs.getContext('2d'); ctx.imageSmoothingEnabled=false;

  function fit(){const w=Math.max(1,Math.floor(innerWidth)),h=Math.max(1,Math.floor(innerHeight));el.cvs.width=w*devicePixelRatio;el.cvs.height=h*devicePixelRatio;el.cvs.style.width=w+'px';el.cvs.style.height=h+'px';}
  addEventListener('resize',fit,{passive:true}); addEventListener('orientationchange',()=>setTimeout(fit,200),{passive:true}); fit();

  const input={left:false,right:false,boost:false};
  function kb(e,down){const k=e.key.toLowerCase(); if(k==='arrowleft'||k==='a')input.left=down; if(k==='arrowright'||k==='d')input.right=down; if(k===' '||k==='b')input.boost=down; if(k==='p'&&down)togglePause();}
  addEventListener('keydown',e=>kb(e,true)); addEventListener('keyup',e=>kb(e,false));
  function setTouch(act,down){ if(act==='left')input.left=down; if(act==='right')input.right=down; if(act==='boost')input.boost=down; }
  ['left','right','boost'].forEach(act=>[...document.querySelectorAll(`[data-act="${act}"]`)].forEach(elm=>{
    elm.addEventListener('pointerdown',e=>{e.preventDefault();setTouch(act,true);});
    elm.addEventListener('pointerup',e=>{e.preventDefault();setTouch(act,false);});
    elm.addEventListener('pointercancel',()=>setTouch(act,false));
    elm.addEventListener('pointerleave',()=>setTouch(act,false));
  }));

  // Audio
  let AC,musicGain,sfxGain;
  async function initAudio(){ if(AC){try{await AC.resume();}catch{} return;} AC=new (window.AudioContext||window.webkitAudioContext)(); try{await AC.resume();}catch{} const master=AC.createGain(); master.gain.value=0.9; master.connect(AC.destination); musicGain=AC.createGain(); musicGain.gain.value=0.22; musicGain.connect(master); sfxGain=AC.createGain(); sfxGain.gain.value=0.38; sfxGain.connect(master); const dist=AC.createWaveShaper(); dist.curve=new Float32Array(256).map((_,i)=>{const x=i/128-1;return Math.tanh(5*x)}); dist.connect(musicGain); function sq(f,d=0){const o=AC.createOscillator(); o.type='square'; o.frequency.value=f; o.detune.value=d; const g=AC.createGain(); g.gain.value=0.1; const del=AC.createDelay(); del.delayTime.value=0.002+Math.random()*0.002; o.connect(g).connect(del).connect(dist); return {o,g};} const s1=sq(110), s2=sq(220,+7), s3=sq(165,-9); [s1.o,s2.o,s3.o].forEach(o=>o.start()); let t=AC.currentTime; (function riff(){ const step=0.16; for(let i=0;i<16;i++){ const tt=t+i*step; const on=(i%4<2)?0.9:0.4; [s1.g,s2.g,s3.g].forEach(g=>{g.gain.cancelScheduledValues(tt); g.gain.setValueAtTime(0.001,tt); g.gain.linearRampToValueAtTime(on*0.14,tt+0.02); g.gain.exponentialRampToValueAtTime(0.001,tt+step*0.9);}); } t+=step*16; setTimeout(riff,step*16*800); })(); }
  function sfxBeep(freq=900,t=0.07){ if(!AC)return; const o=AC.createOscillator(); o.type='triangle'; o.frequency.value=freq; const g=AC.createGain(); g.gain.value=0.001; o.connect(g).connect(sfxGain); const tt=AC.currentTime; g.gain.setValueAtTime(0.35,tt); g.gain.exponentialRampToValueAtTime(0.00001,tt+t); o.start(tt); o.stop(tt+t+0.02); }
  function sfxThud(){ if(!AC)return; const o=AC.createOscillator(); o.type='square'; o.frequency.value=95; const g=AC.createGain(); g.gain.value=0.5; o.connect(g).connect(sfxGain); const t=AC.currentTime; g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.frequency.exponentialRampToValueAtTime(55,t+0.22); o.start(t); o.stop(t+0.25); }

  const state={running:false,paused:false,levelIndex:0,speed:80,passed:0,t:0,x:0,boost:0.25,boosting:false,cars:[],nextSpawnZ:8,quipTimer:0,message:"",timeAlive:0};
  function rand(a,b){return a+Math.random()*(b-a)} function choice(a){return a[(Math.random()*a.length)|0]} function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  function showMenu(show=true){ el.menu.style.display=show?'flex':'none'; el.hud.style.display=show?'none':'flex'; el.touch.style.display=show?'none':'grid'; el.gameover.style.display='none'; }
  function showOver(){ el.hud.style.display='none'; el.touch.style.display='none'; el.gameover.style.display='flex'; el.stats.innerHTML='Level: '+(state.levelIndex+1)+' ‚Äî √úberholt: '+state.passed+' ‚Äî Zeit: '+state.timeAlive.toFixed(1)+'s'; }
  function togglePause(){ if(!state.running)return; state.paused=!state.paused; el.toast.style.display=state.paused?'block':'none'; }

  function laneToX(l){ const s=(l-(LANE_COUNT-1)/2)/((LANE_COUNT-1)/2); return s*ROAD_W*0.8; }

  function drawCar(g,x,z,colBody='#b9a36e',colDark='#6d5c35',isPlayer=false,isEV=false){
    const scale=SCALE_FOV/(z+0.0001); const cx=(LOW_W/2)+x*scale*LOW_W*0.25; const cy=LOW_H*0.62-z*scale*8;
    const w=CAR_SIZE.w*scale*LOW_W, h=CAR_SIZE.h*scale*LOW_H, d=CAR_SIZE.d*scale*LOW_H;
    g.fillStyle="rgba(0,0,0,0.25)"; g.fillRect(cx-w*0.6,cy+d*0.6,w*1.2,h*0.35);
    g.fillStyle=colBody; g.fillRect(cx-w,cy,w*2,h);
    g.fillStyle=colDark; g.fillRect(cx-w*0.7,cy-h*0.2,w*1.4,h*0.5);
    g.fillStyle=isEV?"#6de1ff":"#ffcd66"; g.beginPath(); g.moveTo(cx-w,cy); g.lineTo(cx,cy-h*0.25); g.lineTo(cx+w,cy); g.closePath(); g.fill();
    g.fillStyle=isEV?"#4ab7d5":"#d1a84a"; g.beginPath(); g.moveTo(cx-w,cy+h); g.lineTo(cx,cy+h+h*0.3); g.lineTo(cx+w,cy+h); g.closePath(); g.fill();
    g.fillStyle="rgba(0,0,0,0.35)"; g.fillRect(cx-w*0.8,cy+h*0.1,1,1); g.fillRect(cx+w*0.8-1,cy+h*0.1,1,1);
    if(isPlayer){ g.fillStyle="#ffd35a"; g.fillRect(cx-w*0.2,cy+h*0.2,w*0.4,h*0.12); }
  }

  function drawRoad(g,lev){
    g.save(); g.setTransform(1,0,0,1,0,0); g.fillStyle='#000'; g.fillRect(0,0,el.cvs.width,el.cvs.height); g.restore();
    g.fillStyle=lev.bg; g.fillRect(0,0,LOW_W,LOW_H);
    g.fillStyle="#1e1e26"; for(let i=0;i<6;i++){ const hx=(i*70+(state.t*22)%70)-60; g.beginPath(); g.moveTo(hx,LOW_H*0.46); g.lineTo(hx+35,LOW_H*0.16); g.lineTo(hx+70,LOW_H*0.46); g.closePath(); g.fill(); }
    g.fillStyle="#2d2d2d"; g.beginPath(); g.moveTo(LOW_W*0.15,LOW_H*0.62); g.lineTo(LOW_W*0.85,LOW_H*0.62); g.lineTo(LOW_W*1.00,LOW_H); g.lineTo(LOW_W*0.00,LOW_H); g.closePath(); g.fill();
    g.fillStyle="#cfcfcf"; for(let i=0;i<14;i++){ const z=i*1.0+(state.t*state.speed*0.02)%1; const sc=SCALE_FOV/(z+0.001); const w=1.5+16*sc; const y=LOW_H*0.62+(z*sc*30); const x1=LOW_W*0.33-w*0.5, x2=LOW_W*0.66-w*0.5; g.fillRect(x1,y,w,2); g.fillRect(x2,y,w,2); }
    const grd=g.createLinearGradient(0,LOW_H*0.55,0,LOW_H); grd.addColorStop(0,'rgba(0,0,0,0)'); grd.addColorStop(1,lev.fog); g.fillStyle=grd; g.fillRect(0,LOW_H*0.55,LOW_W,LOW_H*0.45);
  }

  function spawnCar(lev){
    const lane=(Math.random()*LANE_COUNT)|0; const x=laneToX(lane); const z=rand(8,12);
    const hue=(Math.random()*360)|0; const body=`hsl(${hue} 60% 60%)`,dark=`hsl(${hue} 50% 35%)`;
    const v=rand(55,100)*lev.traffic;
    state.cars.push({lane,x,z,v,body,dark,ev:true,alive:true,dir:Math.random()<0.5?-1:1, switchTimer:rand(0.8,2.0)});
  }

  let last=performance.now(), fpsSmoothed=60;
  function loop(now){
    requestAnimationFrame(loop);
    if(!state.running||state.paused) return;
    const dt=Math.min(0.05,(now-last)/1000); last=now; fpsSmoothed=fpsSmoothed*0.9+(1/dt)*0.1; el.fps.textContent=Math.round(fpsSmoothed);
    const lev=LEVELS[state.levelIndex];
    state.t+=dt; state.timeAlive+=dt;

    const steer=(input.right?1:0)-(input.left?1:0); state.x=clamp(state.x+steer*dt*1.7,-1,1);
    state.boost=clamp(state.boost+BOOST_CHARGE_RATE*dt,0,1); const wantBoost=input.boost&&state.boost>0.05; state.boosting=wantBoost;
    if(state.boosting){ state.boost=clamp(state.boost-BOOST_DRAIN*dt,0,1); if(navigator.vibrate)navigator.vibrate(6); sfxBeep(850,0.05); }
    const speedTarget=(state.boosting?MAX_SPEED*BOOST_MULT:MAX_SPEED)*0.62+60; state.speed=clamp(state.speed+(speedTarget-state.speed)*dt*2.2,60,MAX_SPEED*BOOST_MULT);

    el.uiLevel.textContent=(state.levelIndex+1)+" ‚Äì "+lev.name;
    el.uiSpeed.textContent=Math.round(state.speed);
    el.uiPassed.textContent=state.passed;
    el.boostFill.style.width=Math.round(state.boost*100)+"%";

    state.nextSpawnZ-=dt*(state.speed*0.055);
    if(state.nextSpawnZ<=0){ spawnCar(lev); state.nextSpawnZ=rand(lev.minGap*0.6,lev.minGap*1.1); }
    for(const c of state.cars){
      c.z-=dt*(state.speed*0.042);
      c.switchTimer-=dt;
      if(c.switchTimer<=0){
        c.switchTimer=rand(0.7,1.6);
        c.dir = (state.x*ROAD_W*0.8 > c.x)? +1 : -1;
      }
      const targetX = clamp(c.x + c.dir*dt*0.45, -ROAD_W*0.8, ROAD_W*0.8);
      c.x = targetX;
    }
    state.cars=state.cars.filter(c=>c.z>-1);

    for(const c of state.cars){
      if(c.alive&&c.z<0.6&&!c.passed){ c.passed=true; state.passed++; if(Math.random()<0.45) setMessage(choice(QUIPS_PASS),1.4); sfxBeep(1000,0.05); }
      const dz=Math.abs(c.z-0.6), dx=Math.abs((state.x*ROAD_W*0.8)-c.x);
      if(dz<0.33&&dx<0.3){ sfxThud(); if(navigator.vibrate)navigator.vibrate([20,60,20]); gameOver(); return; }
    }

    if(state.passed>=lev.target){
      state.levelIndex++;
      if(state.levelIndex>=LEVELS.length){ setMessage("ABGAS‚ÄëLEGENDE üèÅ",3.5); state.levelIndex=LEVELS.length-1; }
      else { setMessage("Level Up ‚Üí "+LEVELS[state.levelIndex].name,2.2); state.passed=0; }
    }

    const sx=el.cvs.width/LOW_W, sy=el.cvs.height/LOW_H; ctx.setTransform(sx,0,0,sy,0,0); ctx.clearRect(0,0,LOW_W,LOW_H);
    drawRoad(ctx,lev);
    for(const c of state.cars){ const jitter=(Math.sin((state.t*10+c.z*3))*0.02); drawCar(ctx,c.x+jitter,c.z,c.body,c.dark,false,true); }
    drawCar(ctx,state.x*ROAD_W*0.8,0.6,"#c9b27a","#6b5a37",true,false);
    if(state.quipTimer>0){ state.quipTimer-=dt; const a=Math.min(1,state.quipTimer*3.6); ctx.globalAlpha=a; ctx.fillStyle="rgba(0,0,0,0.55)"; const x=LOW_W*0.5,y=LOW_H*0.18; ctx.fillRect(x-70,y-12,140,24); ctx.fillStyle="#fff"; ctx.textAlign="center"; ctx.font="8px monospace"; ctx.fillText(state.message,x,y+7); ctx.globalAlpha=1; }
  }

  function setMessage(msg,sec=1.6){ state.message=msg; state.quipTimer=sec; }
  function gameOver(){ state.running=false; showOver(); }

  function startGame(){
    showMenu(false);
    state.running=true; state.paused=false; state.levelIndex=0; state.speed=80; state.passed=0; state.boost=0.25; state.cars.length=0; state.nextSpawnZ=5.5; state.timeAlive=0;
    setMessage(choice(QUIPS_START),1.6);
    last=performance.now();
    requestAnimationFrame(loop);
    initAudio();
  }

  el.btnStart.addEventListener('click',startGame);
  el.btnHow.addEventListener('click',()=>{ el.how.style.display = (el.how.style.display==='block')?'none':'block'; });
  el.btnQuips.addEventListener('click',()=>{
    el.quipbox.style.display = (el.quipbox.style.display==='block')?'none':'block';
    if(el.quiplist.childElementCount===0){
      const all=[...QUIPS_PASS,...QUIPS_CRASH,...QUIPS_START];
      el.quiplist.innerHTML = '<ul>'+all.map(q=>'<li>'+q+'</li>').join('')+'</ul>';
    }
  });
  el.btnRetry.addEventListener('click',()=>{ startGame(); el.gameover.style.display='none'; });
  el.btnMenu.addEventListener('click',()=>{ showMenu(true); });

  function togglePause(){ if(!state.running)return; state.paused=!state.paused; el.toast.style.display=state.paused?'block':'none'; }
  addEventListener('pointerdown', ()=>{ initAudio(); }, { once:true });
  requestAnimationFrame(loop);
  addEventListener('touchmove', e=>{ e.preventDefault(); }, { passive:false });

  if('serviceWorker' in navigator){ addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js?v=5').catch(()=>{}); }); }
})();
</script>
</body>
</html>
